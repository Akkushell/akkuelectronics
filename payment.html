<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Secure UPI payment - Akku Electronics">
    <base href="../">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://akkuelectronics.in/payment.html">
    <meta property="og:title" content="UPI Payment | Akku Electronics">
    <meta property="og:description" content="Secure UPI checkout page for Akku Electronics orders.">
    <meta property="og:image" content="https://akkuelectronics.in/images/aelogo.png">
    <meta property="og:url" content="https://akkuelectronics.in/payment.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="UPI Payment | Akku Electronics">
    <meta name="twitter:description" content="Secure UPI checkout page for Akku Electronics orders.">
    <meta name="twitter:image" content="https://akkuelectronics.in/images/aelogo.png">
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "UPI Payment | Akku Electronics",
            "url": "https://akkuelectronics.in/payment.html",
            "description": "Secure UPI checkout page for Akku Electronics orders."
        }
        </script>
    <title>UPI Payment | Akku Electronics</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.0.0/dist/index.min.js"></script>
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 100%); color:#ccc; margin:0; padding:20px; }
        .payment-container { max-width: 920px; margin: 0 auto; }
        .payment-header { text-align:center; margin-bottom:28px; border-bottom:2px solid #d4af37; padding-bottom:14px; }
        .payment-header h1 { color:#d4af37; margin:0 0 8px; }
        .payment-content { background: linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%); border:2px solid #d4af37; border-radius:12px; padding:24px; }

        .step-indicator { display:flex; gap:8px; margin-bottom:24px; }
        .step { flex:1; text-align:center; }
        .step-number { width:36px; height:36px; line-height:36px; margin:0 auto 6px; border-radius:50%; background:#444; color:#fff; font-weight:700; }
        .step.active .step-number { background:#f4d03f; color:#000; }
        .step.completed .step-number { background:#90ee90; color:#000; }
        .step-label { font-size:12px; color:#aaa; text-transform:uppercase; }

        .step-content { display:none; }
        .step-content.active { display:block; }

        .order-summary, .panel { background: rgba(0,0,0,.35); border:1px solid #3d3d3d; border-radius:8px; padding:16px; margin-bottom:16px; }
        .order-summary h3, .panel h3 { color:#d4af37; margin:0 0 12px; }
        .order-item { display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px solid #3d3d3d; }
        .order-item:last-child { border-bottom:none; }
        .item-name { color:#fff; font-weight:600; }
        .item-meta, .item-unit { color:#aaa; font-size:13px; }
        .item-price { color:#d4af37; font-weight:700; text-align:right; min-width:130px; }
        .order-total { margin-top:12px; padding-top:12px; border-top:2px solid #d4af37; display:flex; justify-content:space-between; font-weight:700; }

        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .form-group { margin-bottom:14px; }
        label { display:block; margin-bottom:6px; color:#d4af37; font-size:13px; text-transform:uppercase; }
        input, textarea { width:100%; box-sizing:border-box; padding:11px 12px; border-radius:6px; border:2px solid #3d3d3d; background:rgba(0,0,0,.45); color:#fff; font-family:inherit; }
        textarea { min-height:90px; resize:vertical; }
        input:focus, textarea:focus { outline:none; border-color:#d4af37; }

        .qr-wrap { text-align:center; }
        #qrCode { background:#fff; display:inline-block; padding:12px; border-radius:8px; margin:8px 0 10px; }
        .upi-apps { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px; }
        .upi-btn { border:2px solid #3d3d3d; background:rgba(0,0,0,.5); color:#fff; padding:12px; border-radius:8px; font-weight:700; cursor:pointer; }
        .upi-btn.phonepe { border-color:#5A4FCF; color:#5A4FCF; }
        .upi-btn.gpay { border-color:#4285F4; color:#4285F4; }
        .upi-btn.paytm { border-color:#00A699; color:#00A699; }
        .gpay-status { margin-top:10px; color:#aaa; text-align:center; font-size:13px; }

        .button-group { display:flex; gap:10px; justify-content:flex-end; margin-top:18px; }
        .btn { border:none; border-radius:6px; padding:12px 18px; font-weight:700; cursor:pointer; text-transform:uppercase; }
        .btn-primary { background:linear-gradient(135deg,#d4af37 0%,#f4d03f 100%); color:#000; }
        .btn-secondary { background:transparent; border:2px solid #d4af37; color:#d4af37; }
        .btn-success { background:linear-gradient(135deg,#90ee90 0%,#76ee76 100%); color:#000; }

        .error-message { display:none; background:rgba(255,107,107,.2); border:2px solid #ff6b6b; color:#ff8787; padding:10px; border-radius:6px; margin-bottom:10px; }
        .error-message.show { display:block; }

        .success-container { display:none; text-align:center; }
        .success-container.active { display:block; }

        #loadingModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); align-items:center; justify-content:center; z-index:1000; }
        .spinner { width:38px; height:38px; border:4px solid rgba(212,175,55,.25); border-top-color:#d4af37; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { to { transform:rotate(360deg); } }

        @media (max-width: 768px) {
            .form-row { grid-template-columns:1fr; }
            .upi-apps { grid-template-columns:1fr; }
            .button-group { flex-direction:column-reverse; }
            .btn { width:100%; }
        }
    </style>
</head>
<body>
<div class="payment-container">
    <div class="payment-header">
        <h1><i class="fas fa-lock"></i> UPI Payment Gateway</h1>
        <p>Secure UPI checkout (QR + PhonePe + GPay + Paytm)</p>
    </div>

    <div class="payment-content">
        <div class="step-indicator">
            <div class="step active" data-step="1"><div class="step-number">1</div><div class="step-label">Summary</div></div>
            <div class="step" data-step="2"><div class="step-number">2</div><div class="step-label">Details</div></div>
            <div class="step" data-step="3"><div class="step-number">3</div><div class="step-label">UPI Pay</div></div>
            <div class="step" data-step="4"><div class="step-number">4</div><div class="step-label">Confirm</div></div>
        </div>

        <div class="step-content active" data-step="1">
            <div class="order-summary">
                <h3><i class="fas fa-shopping-bag"></i> Order Summary</h3>
                <div id="orderItems"></div>
                <div class="order-total">
                    <span>Total Amount</span>
                    <span id="totalAmount">â‚¹0</span>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goBackToShop()">Back to Shop</button>
                <button type="button" class="btn btn-primary" onclick="goToStep(2)">Continue</button>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <h3 style="color:#d4af37;margin:0 0 12px;">Customer Details</h3>
            <div id="formError" class="error-message"></div>
            <div class="form-row">
                <div class="form-group"><label>Full Name *</label><input id="fullName" type="text"></div>
                <div class="form-group"><label>Email *</label><input id="email" type="email"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Phone *</label><input id="phone" type="tel"></div>
                <div class="form-group"><label>City *</label><input id="city" type="text"></div>
            </div>
            <div class="form-group"><label>Address *</label><textarea id="address"></textarea></div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                <button type="button" class="btn btn-primary" onclick="goToStep(3)">UPI Payment</button>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <div class="panel">
                <h3>Pay with Google Pay API</h3>
                <div id="googlePayButton" style="max-width:360px;margin:0 auto;"></div>
                <div id="googlePayStatus" class="gpay-status">Loading Google Pay...</div>
            </div>

            <div class="panel qr-wrap">
                <h3>Scan UPI QR</h3>
                <div id="qrCode"></div>
                <div>UPI ID: <strong style="color:#d4af37;">akkue89563749@barodampay</strong></div>
                <div style="margin-top:8px;">Amount: <strong id="qrPayableAmount" style="color:#90ee90;">â‚¹0</strong></div>
                <div style="margin-top:8px; word-break:break-all;">
                    <a id="upiPayLink" href="#" target="_blank" rel="noopener" style="color:#7db4ff; text-decoration:underline;">Open UPI Payment Link</a>
                </div>
                <button type="button" class="btn btn-secondary" style="margin-top:10px;" onclick="copyUpiLink()">Copy UPI Link</button>
            </div>

            <div class="panel">
                <h3>Google Pay UPI App (Fallback)</h3>
                <div class="upi-apps">
                    <button class="upi-btn gpay" type="button" onclick="openUPIApp('gpay')">Google Pay</button>
                </div>
            </div>

            <div class="panel">
                <h3>Enter UTR / Transaction ID</h3>
                <input id="utrInput" type="text" maxlength="30" placeholder="Paste UPI UTR / Reference number">
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                <button type="button" class="btn btn-primary" onclick="goToStep(4)">Review Order</button>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <div class="order-summary">
                <h3>Order Details</h3>
                <div id="confirmationItems"></div>
                <div class="order-total"><span>Total Amount</span><span id="confirmationTotal">â‚¹0</span></div>
            </div>
            <div class="order-summary">
                <h3>Delivery</h3>
                <p><strong>Name:</strong> <span id="confirmName"></span></p>
                <p><strong>Email:</strong> <span id="confirmEmail"></span></p>
                <p><strong>Phone:</strong> <span id="confirmPhone"></span></p>
                <p><strong>Address:</strong> <span id="confirmAddress"></span></p>
                <p><strong>Payment:</strong> <span id="confirmPaymentMethod"></span></p>
                <p><strong>UTR:</strong> <span id="confirmUTR"></span></p>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goToStep(3)">Back</button>
                <button type="button" class="btn btn-success" onclick="finalizeOrder()">Confirm & Place</button>
            </div>
        </div>

        <div class="success-container" id="successContainer">
            <h2 style="color:#90ee90;">Order Placed Successfully</h2>
            <p>Order ID: <strong id="orderRefId"></strong></p>
            <div class="button-group" style="justify-content:center;">
                <button type="button" class="btn btn-success" onclick="sendWhatsAppInvoiceCopy()">Send Invoice Copy to WhatsApp</button>
                <button type="button" class="btn btn-primary" onclick="downloadInvoice()">Download Invoice</button>
                <button type="button" class="btn btn-secondary" onclick="goBackToShop()">Continue Shopping</button>
            </div>
        </div>
    </div>
</div>

<div id="loadingModal"><div style="text-align:center;color:#d4af37;"><div class="spinner"></div>Processing order...</div></div>

<script>
    try {
        if (typeof emailjs !== 'undefined' && typeof emailjs.init === 'function') {
            emailjs.init('XcHn6V8lsei-xmPAf');
        }
    } catch (e) {
        console.warn('EmailJS init failed', e);
    }

    let cartData = [];
    let totalAmount = 0;
    let currentStep = 1;
    const upiId = 'akkue89563749@barodampay';
    const storeWhatsAppNumber = '918956389723';
    const gpayConfig = window.AKKU_GPAY_CONFIG || {
        environment: 'TEST',
        merchantName: 'Akku Electronics',
        merchantId: '',
        gateway: 'example',
        gatewayMerchantId: 'exampleGatewayMerchantId'
    };
    let latestUpiLink = '';
    let whatsappPopupWindow = null;
    let googlePaymentsClient = null;
    let gpayPaymentCompleted = false;
    const orderData = { id: 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 1000), items: [], total: 0, customer: {}, paymentMethod: 'UPI', utrId: '' };

    (function init() {
        loadCartData();
        initGooglePayButton();
    })();

    function loadCartData() {
        const buyNow = safeParse(localStorage.getItem('gameShopBuyNowCheckout'));
        const cart = safeParse(localStorage.getItem('gameShopCart'));
        const source = Array.isArray(buyNow) && buyNow.length ? buyNow : (Array.isArray(cart) ? cart : []);

        cartData = source.map(item => ({
            id: item?.id,
            name: item?.name || item?.title || 'Unknown Product',
            price: Number(item?.price ?? 0) || 0,
            quantity: Number(item?.quantity ?? 1) || 1,
            selectedColor: item?.selectedColor || ''
        })).filter(item => item.name && item.price >= 0);

        if (!cartData.length) {
            document.body.innerHTML = '<div style="text-align:center;padding:100px;color:#d4af37;"><h1>Your cart is empty</h1><p><a href="shop.html" style="color:#d4af37;">Back to Shop</a></p></div>';
            return;
        }

        localStorage.removeItem('gameShopBuyNowCheckout');
        localStorage.setItem('gameShopCart', JSON.stringify(cartData));
        displayOrderSummary();
        generateQRCode();
    }

    function safeParse(v) {
        try { return v ? JSON.parse(v) : []; } catch (_) { return []; }
    }

    function displayOrderSummary() {
        totalAmount = 0;
        const html = cartData.map(item => {
            const itemTotal = item.price * item.quantity;
            totalAmount += itemTotal;
            return `
                <div class="order-item">
                    <div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-meta">Qty: ${item.quantity}${item.selectedColor ? ' | Color: ' + item.selectedColor : ''}</div>
                        <div class="item-unit">Unit Price: â‚¹${item.price.toLocaleString()}</div>
                    </div>
                    <div class="item-price">â‚¹${itemTotal.toLocaleString()}</div>
                </div>`;
        }).join('');

        document.getElementById('orderItems').innerHTML = html;
        document.getElementById('confirmationItems').innerHTML = html;
        document.getElementById('totalAmount').textContent = 'â‚¹' + totalAmount.toLocaleString();
        document.getElementById('confirmationTotal').textContent = 'â‚¹' + totalAmount.toLocaleString();

        orderData.items = cartData;
        orderData.total = totalAmount;
        updateUpiPaymentArtifacts();
    }

    function goToStep(step) {
        const target = Number(step);
        if (target > currentStep) {
            if (currentStep === 2 && !validateForm()) return;
            if (currentStep === 3 && !validatePayment()) return;
        }

        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        const next = document.querySelector('.step-content[data-step="' + target + '"]');
        if (!next) return;
        next.classList.add('active');

        document.querySelectorAll('.step').forEach((el, i) => {
            el.classList.remove('active','completed');
            const n = i + 1;
            if (n === target) el.classList.add('active');
            else if (n < target) el.classList.add('completed');
        });

        if (target === 4) displayConfirmation();
        if (target === 3) {
            updateUpiPaymentArtifacts();
            initGooglePayButton();
        }
        currentStep = target;
        window.scrollTo(0, 0);
    }

    function validateForm() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const city = document.getElementById('city').value.trim();
        const address = document.getElementById('address').value.trim();
        if (!fullName) return showError('Please enter your full name'), false;
        if (!email || !email.includes('@')) return showError('Please enter a valid email'), false;
        if (!phone || phone.length < 10) return showError('Please enter a valid phone'), false;
        if (!city) return showError('Please enter your city'), false;
        if (!address || address.length < 10) return showError('Please enter complete address'), false;
        orderData.customer = { name: fullName, email, phone, city, address };
        hideError();
        return true;
    }

    function validatePayment() {
        if (gpayPaymentCompleted && orderData.paymentMethod === 'Google Pay API' && orderData.utrId) {
            hideError();
            return true;
        }
        const utr = document.getElementById('utrInput').value.trim();
        if (!utr || utr.length < 10) return showError('Enter valid UTR/transaction ID (min 10 chars)'), false;
        orderData.paymentMethod = 'UPI';
        orderData.utrId = utr;
        hideError();
        return true;
    }

    function getGooglePaymentsClient() {
        if (!googlePaymentsClient && window.google && google.payments && google.payments.api) {
            googlePaymentsClient = new google.payments.api.PaymentsClient({ environment: gpayConfig.environment || 'TEST' });
        }
        return googlePaymentsClient;
    }

    function setGooglePayStatus(message, isError = false) {
        const el = document.getElementById('googlePayStatus');
        if (!el) return;
        el.textContent = message;
        el.style.color = isError ? '#ff8787' : '#aaa';
    }

    function getBaseCardPaymentMethod() {
        return {
            type: 'CARD',
            parameters: {
                allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                allowedCardNetworks: ['AMEX', 'DISCOVER', 'INTERAC', 'JCB', 'MASTERCARD', 'VISA']
            }
        };
    }

    function getGooglePayCardPaymentMethod() {
        const method = getBaseCardPaymentMethod();
        method.tokenizationSpecification = {
            type: 'PAYMENT_GATEWAY',
            parameters: {
                gateway: gpayConfig.gateway || 'example',
                gatewayMerchantId: gpayConfig.gatewayMerchantId || 'exampleGatewayMerchantId'
            }
        };
        return method;
    }

    function getGooglePayPaymentDataRequest() {
        const total = Number(orderData.total || totalAmount || 0).toFixed(2);
        const request = {
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [getGooglePayCardPaymentMethod()],
            transactionInfo: {
                totalPriceStatus: 'FINAL',
                totalPrice: total,
                countryCode: 'IN',
                currencyCode: 'INR'
            },
            merchantInfo: {
                merchantName: gpayConfig.merchantName || 'Akku Electronics'
            }
        };

        if (gpayConfig.merchantId) {
            request.merchantInfo.merchantId = gpayConfig.merchantId;
        }

        return request;
    }

    function onGooglePayLoaded() {
        initGooglePayButton();
    }

    function initGooglePayButton() {
        const host = document.getElementById('googlePayButton');
        if (!host) return;
        host.innerHTML = '';

        const client = getGooglePaymentsClient();
        if (!client) {
            setGooglePayStatus('Google Pay SDK not ready yet. Please wait or use GPay UPI fallback.', true);
            return;
        }

        const isReadyRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [getBaseCardPaymentMethod()]
        };

        client.isReadyToPay(isReadyRequest).then(function(response) {
            if (!response.result) {
                setGooglePayStatus('Google Pay is not available on this device. Use GPay UPI fallback.', true);
                return;
            }

            const button = client.createButton({
                onClick: onGooglePaymentButtonClicked,
                buttonColor: 'black',
                buttonType: 'pay'
            });
            host.appendChild(button);
            setGooglePayStatus('Google Pay is ready. Tap Pay to continue.');
        }).catch(function() {
            setGooglePayStatus('Google Pay setup failed. Use GPay UPI fallback.', true);
        });
    }

    function onGooglePaymentButtonClicked() {
        const client = getGooglePaymentsClient();
        if (!client) {
            setGooglePayStatus('Google Pay client unavailable.', true);
            return;
        }

        setGooglePayStatus('Opening Google Pay sheet...');
        client.loadPaymentData(getGooglePayPaymentDataRequest())
            .then(function(paymentData) {
                const token = paymentData?.paymentMethodData?.tokenizationData?.token;
                if (!token) {
                    throw new Error('No payment token received from Google Pay');
                }

                gpayPaymentCompleted = true;
                orderData.paymentMethod = 'Google Pay API';
                orderData.utrId = 'GPAY-' + Date.now();

                const utrInput = document.getElementById('utrInput');
                if (utrInput) {
                    utrInput.value = orderData.utrId;
                }

                hideError();
                setGooglePayStatus('Payment authorized. Click Review Order to continue.');
            })
            .catch(function(error) {
                const msg = error && error.statusCode === 'CANCELED'
                    ? 'Payment cancelled. You can try again.'
                    : 'Google Pay failed. Use GPay UPI fallback.';
                setGooglePayStatus(msg, true);
            });
    }

    function showError(message) {
        const el = document.getElementById('formError');
        el.textContent = message;
        el.classList.add('show');
        window.scrollTo(0, 0);
    }

    function hideError() {
        const el = document.getElementById('formError');
        el.classList.remove('show');
        el.textContent = '';
    }

    function generateQRCode() {
        const box = document.getElementById('qrCode');
        box.innerHTML = '';
        const upiUrl = buildUpiUrl('upi');
        latestUpiLink = upiUrl;

        if (typeof QRCode === 'undefined') {
            renderQrFallbackImage(box, upiUrl);
            return;
        }

        try {
            const canvas = document.createElement('canvas');
            box.appendChild(canvas);

            const maybePromise = QRCode.toCanvas(
                canvas,
                upiUrl,
                { width: 250, margin: 1, color: { dark: '#000000', light: '#ffffff' } },
                function (error) {
                    if (error) {
                        box.innerHTML = '';
                        renderQrFallbackImage(box, upiUrl);
                    }
                }
            );

            if (maybePromise && typeof maybePromise.catch === 'function') {
                maybePromise.catch(function () {
                    box.innerHTML = '';
                    renderQrFallbackImage(box, upiUrl);
                });
            }
        } catch (error) {
            box.innerHTML = '';
            renderQrFallbackImage(box, upiUrl);
        }
    }

    function renderQrFallbackImage(container, upiUrl) {
        const qrImage = document.createElement('img');
        qrImage.alt = 'UPI QR Code';
        qrImage.width = 250;
        qrImage.height = 250;
        qrImage.src = 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=' + encodeURIComponent(upiUrl);
        qrImage.style.display = 'block';
        qrImage.style.maxWidth = '100%';
        qrImage.style.height = 'auto';
        container.appendChild(qrImage);
    }

    function updateUpiPaymentArtifacts() {
        generateQRCode();

        const amountEl = document.getElementById('qrPayableAmount');
        if (amountEl) {
            amountEl.textContent = 'â‚¹' + (orderData.total || totalAmount || 0).toLocaleString();
        }

        const linkEl = document.getElementById('upiPayLink');
        if (linkEl) {
            linkEl.href = latestUpiLink || buildUpiUrl('upi');
        }
    }

    function copyUpiLink() {
        const upiLink = latestUpiLink || buildUpiUrl('upi');
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(upiLink).then(() => {
                alert('UPI payment link copied');
            }).catch(() => {
                fallbackCopyUpiLink(upiLink);
            });
            return;
        }
        fallbackCopyUpiLink(upiLink);
    }

    function fallbackCopyUpiLink(link) {
        const textarea = document.createElement('textarea');
        textarea.value = link;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('UPI payment link copied');
    }

    function buildUpiUrl(app) {
        const params = new URLSearchParams({
            pa: upiId,
            pn: 'Akku Electronics',
            am: String(orderData.total || totalAmount || 0),
            cu: 'INR',
            tn: 'Order ' + orderData.id,
            tr: 'TR' + Date.now()
        });
        if (app === 'phonepe') params.set('app', 'phonepe');
        if (app === 'paytm') params.set('app', 'paytm');
        return 'upi://pay?' + params.toString();
    }

    function openUPIApp(app) {
        gpayPaymentCompleted = false;
        orderData.paymentMethod = 'UPI';
        window.location.href = buildUpiUrl(app);
    }

    function displayConfirmation() {
        document.getElementById('confirmName').textContent = orderData.customer.name || '-';
        document.getElementById('confirmEmail').textContent = orderData.customer.email || '-';
        document.getElementById('confirmPhone').textContent = orderData.customer.phone || '-';
        document.getElementById('confirmAddress').textContent = orderData.customer.address || '-';
        document.getElementById('confirmPaymentMethod').textContent = orderData.paymentMethod || 'UPI';
        document.getElementById('confirmUTR').textContent = orderData.utrId || '-';
    }

    function goBackToShop() {
        window.location.href = 'shop.html';
    }

    function showLoadingModal() {
        document.getElementById('loadingModal').style.display = 'flex';
    }

    function hideLoadingModal() {
        document.getElementById('loadingModal').style.display = 'none';
    }

    function finalizeOrder() {
        if (!orderData.customer.name) {
            showError('Please complete all steps');
            return;
        }

        // Pre-open popup on direct user click to improve WhatsApp open reliability
        try {
            whatsappPopupWindow = window.open('', '_blank');
        } catch (_) {
            whatsappPopupWindow = null;
        }

        showLoadingModal();
        setTimeout(processOrder, 700);
    }

    async function processOrder() {
        await generateInvoice();
        sendEmailNotification();
        logToGoogleSheets();
        hideLoadingModal();

        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById('successContainer').classList.add('active');
        document.getElementById('orderRefId').textContent = orderData.id;
        document.querySelectorAll('.step').forEach(el => { el.classList.remove('active'); el.classList.add('completed'); });

        // Best-effort auto WhatsApp open after order success
        sendWhatsAppInvoiceCopy(true);

        localStorage.removeItem('gameShopCart');
    }

    function buildWhatsAppInvoiceMessage() {
        const itemSummary = (orderData.items || []).map(i => `${i.name}${i.selectedColor ? ' (' + i.selectedColor + ')' : ''} x${i.quantity}`).join(', ');

        return [
            'ðŸ§¾ *Akku Electronics - Customer Invoice Copy*',
            '',
            `ðŸ“Œ Order ID: *${orderData.id}*`,
            `ðŸ“… Date: *${new Date().toLocaleString('en-IN')}*`,
            '',
            '*ðŸ‘¤ Customer*',
            `Name: ${orderData.customer.name || '-'}`,
            `Phone: ${orderData.customer.phone || '-'}`,
            `Email: ${orderData.customer.email || '-'}`,
            `Address: ${orderData.customer.address || '-'}`,
            '',
            '*ðŸ›’ Items*',
            itemSummary || '-',
            '',
            '*ðŸ’³ Payment*',
            `Method: ${orderData.paymentMethod || 'UPI'}`,
            `UTR: ${orderData.utrId || 'N/A'}`,
            `Total: â‚¹${(orderData.total || 0).toLocaleString('en-IN')}`,
            '',
            'Please verify this payment and process the order.'
        ].join('\n');
    }

    function getWhatsAppInvoiceUrl() {
        const message = buildWhatsAppInvoiceMessage();
        return 'https://wa.me/' + storeWhatsAppNumber + '?text=' + encodeURIComponent(message);
    }

    function sendWhatsAppInvoiceCopy(isAuto = false) {
        const whatsappUrl = getWhatsAppInvoiceUrl();

        try {
            if (whatsappPopupWindow && !whatsappPopupWindow.closed) {
                whatsappPopupWindow.location.href = whatsappUrl;
                whatsappPopupWindow.focus();
                whatsappPopupWindow = null;
            } else {
                const target = isAuto ? '_blank' : '_self';
                const win = window.open(whatsappUrl, target);
                if (!win && isAuto) {
                    alert('Popup blocked. Click "Send Invoice Copy to WhatsApp" button.');
                }
            }
        } catch (_) {
            if (isAuto) {
                alert('Could not open WhatsApp automatically. Click "Send Invoice Copy to WhatsApp" button.');
            } else {
                window.location.href = whatsappUrl;
            }
        }
    }

    function replaceTemplateValue(template, key, value) {
        return template.split(`{{${key}}}`).join(value);
    }

    async function generateInvoice() {
        const productSummary = orderData.items.map(i => `${i.name}${i.selectedColor ? ' (' + i.selectedColor + ')' : ''} x ${i.quantity}`).join(', ');
        const data = {
            to_name: orderData.customer.name || '-',
            to_email: orderData.customer.email || '-',
            order_id: orderData.id,
            timestamp: new Date().toLocaleString('en-IN'),
            product_name: productSummary || 'Gaming Product',
            amount: (orderData.total || 0).toLocaleString('en-IN'),
            utr: orderData.utrId || 'N/A'
        };

        try {
            let templateHTML = '';
            const candidatePaths = ['invoice.html', 'shop/invoice.html'];
            let templateLoaded = false;

            for (const path of candidatePaths) {
                try {
                    const response = await fetch(path, { cache: 'no-store' });
                    if (response.ok) {
                        templateHTML = await response.text();
                        templateLoaded = true;
                        break;
                    }
                } catch (_) {
                    // continue to next candidate path
                }
            }

            if (!templateLoaded) {
                throw new Error('Failed to fetch invoice template');
            }

            templateHTML = replaceTemplateValue(templateHTML, 'to_name', data.to_name);
            templateHTML = replaceTemplateValue(templateHTML, 'to_email', data.to_email);
            templateHTML = replaceTemplateValue(templateHTML, 'order_id', data.order_id);
            templateHTML = replaceTemplateValue(templateHTML, 'timestamp', data.timestamp);
            templateHTML = replaceTemplateValue(templateHTML, 'product_name', data.product_name);
            templateHTML = replaceTemplateValue(templateHTML, 'amount', data.amount);
            templateHTML = replaceTemplateValue(templateHTML, 'utr', data.utr);

            window.invoiceHTML = templateHTML;
        } catch (error) {
            const fallbackInvoice = `
                <div style="font-family:Arial,sans-serif;padding:20px;color:#333;">
                    <h2>AKKU ELECTRONICS</h2>
                    <p><strong>Order:</strong> ${orderData.id}</p>
                    <p><strong>Name:</strong> ${orderData.customer.name}</p>
                    <p><strong>Phone:</strong> ${orderData.customer.phone}</p>
                    <p><strong>Email:</strong> ${orderData.customer.email}</p>
                    <p><strong>Address:</strong> ${orderData.customer.address}</p>
                    <hr>
                    ${orderData.items.map(i => `<p>${i.name} x ${i.quantity} - â‚¹${(i.price * i.quantity).toLocaleString()}</p>`).join('')}
                    <hr>
                    <p><strong>Total:</strong> â‚¹${orderData.total.toLocaleString()}</p>
                    <p><strong>Payment:</strong> UPI</p>
                    <p><strong>UTR:</strong> ${orderData.utrId || 'N/A'}</p>
                </div>`;
            window.invoiceHTML = fallbackInvoice;
            console.warn('Using fallback invoice format:', error);
        }
    }

    async function downloadInvoice() {
        if (!window.invoiceHTML) {
            await generateInvoice();
        }
        const element = document.createElement('div');
        element.innerHTML = window.invoiceHTML || '';
        const opt = {
            margin: 0,
            filename: orderData.id + '_invoice.pdf',
            image: { type: 'jpeg', quality: 0.99 },
            html2canvas: { scale: 3, useCORS: true, logging: false },
            jsPDF: { orientation: 'portrait', unit: 'mm', format: [148, 210] },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        html2pdf().set(opt).from(element).save();
    }

    function sendEmailNotification() {
        const params = {
            to_email: orderData.customer.email,
            order_id: orderData.id,
            customer_name: orderData.customer.name,
            total_amount: 'â‚¹' + orderData.total.toLocaleString(),
            payment_method: orderData.paymentMethod || 'UPI',
            utr_id: orderData.utrId || 'N/A'
        };
        if (typeof emailjs !== 'undefined' && typeof emailjs.send === 'function') {
            emailjs.send('service_b76qk0p', 'template_o0reqai', params).catch(() => {});
        }
    }

    function logToGoogleSheets() {
        const url = 'https://script.google.com/macros/s/AKfycbwI6_6GBjAQh6tR8hnW2hXDPdg2T_tTigLpxflXDtaBlqS0Ia4J9vb5v2z1eNiey-1k/exec';
        
        // Build product summary with names and quantities
        const productDetails = orderData.items.map(item => {
            const colorInfo = item.selectedColor ? ` (${item.selectedColor})` : '';
            return `${item.name}${colorInfo} x${item.quantity}`;
        }).join(', ');
        
        const params = new URLSearchParams({
            orderId: orderData.id,
            customerName: orderData.customer.name,
            email: orderData.customer.email,
            phone: orderData.customer.phone,
            address: orderData.customer.address,
            city: orderData.customer.city,
            productDetails: productDetails,
            totalAmount: orderData.total,
            paymentMethod: orderData.paymentMethod || 'UPI',
            utrId: orderData.utrId || 'N/A',
            timestamp: new Date().toLocaleString('en-IN')
        });
        
        fetch(url + '?' + params.toString(), { 
            method: 'GET',
            mode: 'no-cors'
        }).then(() => console.log('Order logged to sheets')).catch(err => console.error('Sheets logging failed:', err));
    }
</script>
</body>
</html> 